___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "GetCookies CMP",
  "description": "GetCookies is a Consent Management Platform (CMP) that helps make your use of cookies and online tracking compliant with GDPR, CCPA, and other privacy regulations. Includes full Google Consent Mode v2 support.",
  "categories": [
    "TAG_MANAGEMENT",
    "PERSONALIZATION"
  ],
  "brand": {
    "id": "getcookies",
    "displayName": "GetCookies",
    "thumbnail": "data:image/png;base64,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"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "domainId",
    "displayName": "Domain ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "REGEX",
        "args": [
          "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$"
        ]
      },
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Find your Domain ID in the GetCookies dashboard at https://getcookies.co under Domains â†’ Widget Configuration",
    "valueHint": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "notSetText": "Please enter your Domain ID from the GetCookies dashboard"
  },
  {
    "type": "CHECKBOX",
    "name": "consentModeEnabled",
    "checkboxText": "Enable Google Consent Mode v2",
    "simpleValueType": true,
    "defaultValue": true,
    "help": "Enable Consent Mode if one or more of your tags rely on Google\u0027s consent API. GetCookies will automatically signal the user\u0027s consent choices to Google tags (Analytics, Ads, etc.).",
    "alwaysInSummary": true
  },
  {
    "type": "GROUP",
    "name": "consentModeSettings",
    "displayName": "Consent Mode Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "waitForUpdate",
        "displayName": "Wait for update (milliseconds)",
        "simpleValueType": true,
        "defaultValue": 500,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "NON_NEGATIVE_NUMBER"
          }
        ],
        "help": "How long Google tags will wait for consent before firing in cookieless mode. Recommended: 500ms.",
        "valueUnit": "milliseconds"
      },
      {
        "type": "SELECT",
        "name": "adsDataRedaction",
        "displayName": "Redact ads data when consent denied",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "dynamic",
            "displayValue": "Dynamic (match ad_storage)"
          },
          {
            "value": true,
            "displayValue": "Always redact"
          },
          {
            "value": false,
            "displayValue": "Never redact"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "dynamic",
        "help": "When enabled and ad_storage consent is denied, ad click identifiers sent in network requests by Google Ads and Floodlight tags will be redacted."
      },
      {
        "type": "CHECKBOX",
        "name": "urlPassthrough",
        "checkboxText": "Enable URL passthrough",
        "simpleValueType": true,
        "defaultValue": true,
        "help": "When enabled, ad click information (gclid, dclid, etc.) will be passed through URL parameters across pages when cookies are denied, helping preserve conversion measurement."
      }
    ],
    "enablingConditions": [
      {
        "paramName": "consentModeEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "defaultConsentSettings",
    "displayName": "Default Consent State",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SELECT",
        "name": "defaultAnalytics",
        "displayName": "Analytics (analytics_storage)",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "denied",
            "displayValue": "Denied"
          },
          {
            "value": "granted",
            "displayValue": "Granted"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied",
        "help": "Default state for analytics cookies (Google Analytics, etc.)"
      },
      {
        "type": "SELECT",
        "name": "defaultAdStorage",
        "displayName": "Advertising (ad_storage)",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "denied",
            "displayValue": "Denied"
          },
          {
            "value": "granted",
            "displayValue": "Granted"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied",
        "help": "Default state for advertising cookies (Google Ads, Meta Pixel, etc.)"
      },
      {
        "type": "SELECT",
        "name": "defaultAdUserData",
        "displayName": "Ad User Data (ad_user_data)",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "denied",
            "displayValue": "Denied"
          },
          {
            "value": "granted",
            "displayValue": "Granted"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied",
        "help": "Default state for sending user data to Google for advertising purposes"
      },
      {
        "type": "SELECT",
        "name": "defaultAdPersonalization",
        "displayName": "Ad Personalization (ad_personalization)",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "denied",
            "displayValue": "Denied"
          },
          {
            "value": "granted",
            "displayValue": "Granted"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied",
        "help": "Default state for personalized advertising (remarketing)"
      },
      {
        "type": "SELECT",
        "name": "defaultFunctionality",
        "displayName": "Functionality (functionality_storage)",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "denied",
            "displayValue": "Denied"
          },
          {
            "value": "granted",
            "displayValue": "Granted"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied",
        "help": "Default state for functionality cookies (preferences, language settings)"
      },
      {
        "type": "SELECT",
        "name": "defaultPersonalization",
        "displayName": "Personalization (personalization_storage)",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "denied",
            "displayValue": "Denied"
          },
          {
            "value": "granted",
            "displayValue": "Granted"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied",
        "help": "Default state for personalization cookies (recommendations, content customization)"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "consentModeEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "help": "Configure the default consent state before user interaction. For GDPR compliance, all should be set to \u0027Denied\u0027."
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const injectScript = require('injectScript');
const setDefaultConsentState = require('setDefaultConsentState');
const updateConsentState = require('updateConsentState');
const gtagSet = require('gtagSet');
const JSON = require('JSON');
const localStorage = require('localStorage');
const setInWindow = require('setInWindow');
const logToConsole = require('logToConsole');
const queryPermission = require('queryPermission');

// Configuration from template parameters
const domainId = data.domainId;
const consentModeEnabled = data.consentModeEnabled !== false;
const waitForUpdate = data.waitForUpdate || 500;
const urlPassthrough = data.urlPassthrough !== false;
const adsDataRedaction = data.adsDataRedaction || 'dynamic';

// Default consent values from settings
const defaultAnalytics = data.defaultAnalytics || 'denied';
const defaultAdStorage = data.defaultAdStorage || 'denied';
const defaultAdUserData = data.defaultAdUserData || 'denied';
const defaultAdPersonalization = data.defaultAdPersonalization || 'denied';
const defaultFunctionality = data.defaultFunctionality || 'denied';
const defaultPersonalization = data.defaultPersonalization || 'denied';

// Storage key for consent (must match GetCookies widget)
const CONSENT_KEY = 'getcookies_consent';

// Set up Google Consent Mode v2
if (consentModeEnabled) {
  // Set URL passthrough and developer ID
  gtagSet({
    'url_passthrough': urlPassthrough,
    'developer_id.dGetCookies': true
  });

  // Set default consent state (before any tags fire)
  const defaultConsent = {
    ad_storage: defaultAdStorage,
    ad_user_data: defaultAdUserData,
    ad_personalization: defaultAdPersonalization,
    analytics_storage: defaultAnalytics,
    functionality_storage: defaultFunctionality,
    personalization_storage: defaultPersonalization,
    security_storage: 'granted',
    wait_for_update: waitForUpdate
  };

  setDefaultConsentState(defaultConsent);
  logToConsole('GetCookies: Default consent state set', defaultConsent);

  // Check for existing consent in localStorage
  if (queryPermission('access_local_storage', 'read', CONSENT_KEY)) {
    const storedConsent = localStorage.getItem(CONSENT_KEY);

    if (storedConsent) {
      const parsed = JSON.parse(storedConsent);

      if (parsed && parsed.categories) {
        const categories = parsed.categories;
        const hasAnalytics = categories.indexOf('analytics') > -1;
        const hasMarketing = categories.indexOf('marketing') > -1 || categories.indexOf('advertising') > -1;
        const hasPreferences = categories.indexOf('preferences') > -1 || categories.indexOf('functional') > -1;

        const consentUpdate = {
          ad_storage: hasMarketing ? 'granted' : 'denied',
          ad_user_data: hasMarketing ? 'granted' : 'denied',
          ad_personalization: hasMarketing ? 'granted' : 'denied',
          analytics_storage: hasAnalytics ? 'granted' : 'denied',
          functionality_storage: hasPreferences ? 'granted' : 'denied',
          personalization_storage: hasPreferences ? 'granted' : 'denied',
          security_storage: 'granted'
        };

        updateConsentState(consentUpdate);
        logToConsole('GetCookies: Restored consent from storage', consentUpdate);

        // Set ads data redaction based on marketing consent
        const redactionValue = adsDataRedaction === 'dynamic' ? !hasMarketing : adsDataRedaction === true;
        gtagSet({ 'ads_data_redaction': redactionValue });
      }
    } else {
      // No stored consent - set initial ads data redaction (denied state)
      const redactionValue = adsDataRedaction === 'dynamic' ? true : adsDataRedaction === true;
      gtagSet({ 'ads_data_redaction': redactionValue });
    }
  }
}

// Set up listener for consent updates from GetCookies widget
setInWindow('__GetCookiesGTM', {
  updateConsent: function(choices) {
    if (!consentModeEnabled) return;

    const consentUpdate = {
      ad_storage: choices.marketing ? 'granted' : 'denied',
      ad_user_data: choices.marketing ? 'granted' : 'denied',
      ad_personalization: choices.marketing ? 'granted' : 'denied',
      analytics_storage: choices.analytics ? 'granted' : 'denied',
      functionality_storage: choices.preferences ? 'granted' : 'denied',
      personalization_storage: choices.preferences ? 'granted' : 'denied',
      security_storage: 'granted'
    };

    updateConsentState(consentUpdate);

    // Update ads data redaction
    const marketingGranted = choices.marketing === true;
    const redactionValue = adsDataRedaction === 'dynamic' ? !marketingGranted : adsDataRedaction === true;
    gtagSet({ 'ads_data_redaction': redactionValue });

    logToConsole('GetCookies: Consent updated by user', consentUpdate);
  }
}, true);

// Set domain ID as global variable so widget.js can read it
setInWindow('__GETCOOKIES_DOMAIN_ID', domainId, true);

// Build the loader script URL with domain ID
const scriptUrl = 'https://api.getcookies.co/api/v1/widget/loader.js?id=' + domainId;

// Inject the GetCookies widget script
injectScript(scriptUrl, function() {
  logToConsole('GetCookies: Widget loaded successfully for domain ' + domainId);
  data.gtmOnSuccess();
}, function() {
  logToConsole('GetCookies: Failed to load widget script');
  data.gtmOnFailure();
}, 'getcookies-widget');


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://getcookies.co/*"
              },
              {
                "type": 1,
                "string": "https://api.getcookies.co/*"
              },
              {
                "type": 1,
                "string": "https://getcookies.co/static/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_local_storage",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "getcookies_consent"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ads_data_redaction"
              },
              {
                "type": 1,
                "string": "url_passthrough"
              },
              {
                "type": 1,
                "string": "developer_id.dGetCookies"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "__GetCookiesGTM"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "__GETCOOKIES_DOMAIN_ID"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Sets default consent state when consent mode enabled
  code: |-
    const mockData = {
      domainId: '12345678-1234-1234-1234-123456789012',
      consentModeEnabled: true,
      waitForUpdate: 500,
      urlPassthrough: true,
      adsDataRedaction: 'dynamic',
      defaultAnalytics: 'denied',
      defaultAdStorage: 'denied',
      defaultAdUserData: 'denied',
      defaultAdPersonalization: 'denied',
      defaultFunctionality: 'denied',
      defaultPersonalization: 'denied'
    };

    mock('setDefaultConsentState', function(consent) {
      assertThat(consent.ad_storage).isEqualTo('denied');
      assertThat(consent.analytics_storage).isEqualTo('denied');
      assertThat(consent.wait_for_update).isEqualTo(500);
    });

    mock('gtagSet', function() {});
    mock('localStorage', { getItem: function() { return null; } });
    mock('setInWindow', function() {});
    mock('injectScript', function(url, onSuccess) { onSuccess(); });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();

- name: Restores consent from localStorage
  code: |-
    const mockData = {
      domainId: '12345678-1234-1234-1234-123456789012',
      consentModeEnabled: true,
      waitForUpdate: 500,
      adsDataRedaction: 'dynamic'
    };

    const storedConsent = JSON.stringify({
      categories: ['necessary', 'analytics', 'marketing']
    });

    mock('setDefaultConsentState', function() {});
    mock('updateConsentState', function(consent) {
      assertThat(consent.analytics_storage).isEqualTo('granted');
      assertThat(consent.ad_storage).isEqualTo('granted');
    });
    mock('gtagSet', function() {});
    mock('localStorage', { getItem: function() { return storedConsent; } });
    mock('queryPermission', function() { return true; });
    mock('setInWindow', function() {});
    mock('injectScript', function(url, onSuccess) { onSuccess(); });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();


___NOTES___

GetCookies CMP - Google Tag Manager Template
Version 1.0.0

Features:
- Full Google Consent Mode v2 support
- Sets default consent state BEFORE any tags fire
- Reads existing consent from localStorage
- Real-time consent updates when user interacts with banner
- Supports all consent types: ad_storage, ad_user_data, ad_personalization, analytics_storage, functionality_storage, personalization_storage
- URL passthrough for conversion measurement when cookies denied
- Ads data redaction option

For documentation, visit: https://getcookies.co/help/gtm-installation
For support, visit: https://getcookies.co/support

Copyright 2024 GetCookies
Licensed under Apache License 2.0
